<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="CommunityDAO">
	<!-- 시작 페이지 -->
	<select id="cmty_index" resultType="com.happypaws.vo.CommunityVO">
		SELECT * FROM community WHERE cmty_del="N" ORDER BY cmty_seq DESC LIMIT 10
	</select>

	<!-- 커뮤니티 목록보기 -->
	<select id="cmty_list" resultType="com.happypaws.vo.CommunityVO">
		SELECT COMMUNITY.* , (SELECT COUNT(*) 
         FROM cmty_comment 
         WHERE cmty_comment.cmty_seq = COMMUNITY.cmty_seq and cmty_cmt_del ='N') AS comment_count,
         users.us_profile,
    	 users.us_nick
		FROM COMMUNITY LEFT JOIN USERS ON COMMUNITY.CMTY_ID = USERS.US_ID 
    	WHERE 1=1 AND CMTY_DEL = 'N' 
	    <if test="cmty_category != 'all' and cmty_category != null">
	          and cmty_category = #{cmty_category}
	    </if>
		<if test="searchCondition == 'TITLE' "> AND CMTY_TITLE LIKE CONCAT('%',#{searchKeyword},'%') </if>
		<if test="searchCondition == 'CONTENT' "> AND CMTY_CONTENT LIKE CONCAT('%',#{searchKeyword},'%') </if>
		ORDER BY CMTY_SEQ DESC
		LIMIT #{listcnt} OFFSET #{start}
	</select>
	
	<!--  커뮤니티 글 갯수 -->
	<select id="countCmty" resultType="int">
		SELECT COUNT(*) FROM COMMUNITY WHERE 1=1 AND CMTY_DEL = 'N'
		<if test="cmty_category != 'all' and cmty_category != null">
	          and cmty_category = #{cmty_category}
	    </if>
		<if test="searchCondition == 'TITLE' "> AND CMTY_TITLE LIKE CONCAT('%',#{searchKeyword},'%') </if>
		<if test="searchCondition == 'CONTENT' "> AND CMTY_CONTENT LIKE CONCAT('%',#{searchKeyword},'%') </if>
	</select>
	
	<!--커뮤니티 상세보기 -->
	<select id="cmty_view" resultType="com.happypaws.vo.CommunityVO">
		SELECT COMMUNITY.* , USERS.US_PROFILE, USERS.US_NICK 
		FROM COMMUNITY , USERS
		WHERE CMTY_SEQ= #{cmty_seq} AND CMTY_DEL = 'N' AND US_ID = CMTY_ID;
	</select>
	
	<!-- 커뮤니티 카운트 -->
	<update id="cmty_count">
		UPDATE COMMUNITY SET CMTY_COUNT = IFNULL(#{cmty_count}, 0)+1 WHERE CMTY_SEQ = #{cmty_seq}
	</update>
	
	<!-- 커뮤니티 수정 -->
	<update id="cmty_update">
		UPDATE COMMUNITY
		SET CMTY_TITLE = #{cmty_title} , CMTY_CONTENT = #{cmty_content} , CMTY_CATEGORY = #{cmty_category}
		WHERE CMTY_SEQ = #{cmty_seq}
	</update>
	
	
	<!-- 커뮤니티 글쓰기 -->
	<insert id="cmty_insert" parameterType="com.happypaws.vo.CommunityVO">
	    INSERT INTO community (cmty_id, cmty_title, cmty_content, cmty_date, cmty_category)
        VALUES (#{cmty_id}, #{cmty_title}, #{cmty_content}, NOW(), #{cmty_category})
	</insert>
	
	<!-- 커뮤니티 삭제 -->
	<update id="cmty_delete">
		UPDATE COMMUNITY 
		SET CMTY_DEL = 'Y'
		WHERE CMTY_SEQ = #{cmty_seq}
	</update>
	
	<!-- 커뮤니티 댓글기능 -->
	<insert id="c_addComment">
	    INSERT INTO cmty_comment (cmty_seq, cmty_cmt_id, cmty_cmt_content, cmty_cmt_date)
        VALUES (#{cmty_seq}, #{cmty_cmt_id}, #{cmty_cmt_content}, NOW())
	</insert>
	
	<!--  댓글 삭제 -->
	<update id="c_delComment">
		UPDATE cmty_comment
		SET cmty_cmt_del = "Y"
		WHERE cmty_cmt_seq = #{cmty_cmt_seq}
	</update>	
	
	<!-- 댓글 수정 -->
	<update id="c_updateComment">
		UPDATE cmty_comment 
		SET cmty_cmt_content = #{cmty_cmt_content}
		where cmty_cmt_seq = #{cmty_cmt_seq}
	</update>
	
	<!-- 커뮤니티 댓글목록 -->
	<select id="c_commentList" resultType="com.happypaws.vo.CmtyCommentVO">
		WITH RECURSIVE CommentHierarchy AS (
		    -- 최상위 댓글 조회 (cmty_cmt_parent_seq가 NULL인 댓글)
		    SELECT 
		        cm.*,
		        u.us_nick,
		        u.us_profile,
		        1 AS depth,
		        cm.cmty_cmt_seq AS sort_order,
		        CASE 
		            WHEN EXISTS (
		                SELECT 1 
		                FROM cmty_comment child 
		                WHERE child.cmty_cmt_parent_seq = cm.cmty_cmt_seq AND child.cmty_cmt_del = 'N'
		            ) THEN 1
		            ELSE 0
		        END AS has_active_child
		    FROM 
		        cmty_comment cm
		    LEFT JOIN 
		        users u ON cm.cmty_cmt_id = u.us_id
		    WHERE 
		        cm.cmty_cmt_parent_seq IS NULL 
		        AND cm.cmty_seq = #{cmty_seq}
		        AND (cm.cmty_cmt_del = 'N' OR (cm.cmty_cmt_del = 'Y' AND EXISTS (
		                SELECT 1 
		                FROM cmty_comment child 
		                WHERE child.cmty_cmt_parent_seq = cm.cmty_cmt_seq AND child.cmty_cmt_del = 'N'
		            )))
		
		    UNION ALL
		
		    -- 대댓글 연결 (최상위 댓글의 자식 댓글들)
		    SELECT 
		        c.*,
		        u.us_nick,
		        u.us_profile,
		        ch.depth + 1 AS depth, 
		        ch.sort_order,
		        CASE 
		            WHEN EXISTS (
		                SELECT 1 
		                FROM cmty_comment child 
		                WHERE child.cmty_cmt_parent_seq = c.cmty_cmt_seq AND child.cmty_cmt_del = 'N'
		            ) THEN 1
		            ELSE 0
		        END AS has_active_child
		    FROM 
		        cmty_comment c
		    INNER JOIN 
		        CommentHierarchy ch ON c.cmty_cmt_parent_seq = ch.cmty_cmt_seq
		    LEFT JOIN 
		        users u ON c.cmty_cmt_id = u.us_id
		    WHERE 
		        c.cmty_cmt_del = 'N' OR (c.cmty_cmt_del = 'Y' AND EXISTS (
		                SELECT 1 
		                FROM cmty_comment child 
		                WHERE child.cmty_cmt_parent_seq = c.cmty_cmt_seq AND child.cmty_cmt_del = 'N'
		            ))
		)
		SELECT * 
		FROM CommentHierarchy 
		ORDER BY sort_order, depth, cmty_cmt_date;
	</select>
	
	<!-- 커뮤니티 대댓글기능 -->
	<insert id="c_addReply">
	    INSERT INTO cmty_comment (cmty_seq, cmty_cmt_parent_seq , cmty_cmt_id, cmty_cmt_content, cmty_cmt_date)
        VALUES (#{cmty_seq},#{cmty_cmt_parent_seq} ,#{cmty_cmt_id}, #{cmty_cmt_content}, NOW())
	</insert>
	
	<!-- 추천 -->
	<insert id="cmty_up">
        INSERT INTO cmty_up (cmty_seq, us_id)
        VALUES (#{cmty_seq}, #{us_id})
    </insert>
    
    <!-- 추천 삭제 -->
    <delete id="cmty_up_del">
        DELETE FROM cmty_up
        WHERE cmty_seq = #{cmty_seq} AND us_id = #{us_id}
    </delete>

    <!-- 전체 추천 수 가져오기 -->
    <select id="cmty_up_cut"  resultType="int" >
        SELECT COUNT(*) FROM cmty_up WHERE cmty_seq = #{cmty_seq}
    </select>
	
	<!-- 추천id ok -->
	<select id="cmty_up_ok" resultType="int" >
        SELECT COUNT(*) FROM cmty_up 
        WHERE cmty_seq = #{cmty_seq} and us_id = #{us_id}
    </select>
    
</mapper>
